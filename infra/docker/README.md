# SignalForge Monitoring Infrastructure

## Prometheus Configuration

This directory contains the Prometheus configuration for monitoring SignalForge.

### Files

- `prometheus.yml`: Prometheus scrape configuration

### Configuration Overview

The Prometheus configuration scrapes metrics from the SignalForge API every 15 seconds.

#### Scrape Targets

- **SignalForge API**: `signalforge-api:8000/metrics`
  - Collects application metrics including request latency, throughput, error rates, ML model performance, and database query performance
  - Labels: `service=signalforge-api`, `environment=production`

- **Prometheus Self-Monitoring**: `localhost:9090`
  - Monitors Prometheus itself

### Running Prometheus with Docker

To run Prometheus with this configuration:

```bash
docker run -d \
  --name prometheus \
  -p 9090:9090 \
  -v $(pwd)/prometheus.yml:/etc/prometheus/prometheus.yml \
  prom/prometheus:latest
```

Or add to your `docker-compose.yml`:

```yaml
services:
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./infra/docker/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - signalforge-network

volumes:
  prometheus-data:

networks:
  signalforge-network:
```

### Accessing Prometheus

Once running, access Prometheus at: `http://localhost:9090`

### Available Metrics

The SignalForge API exposes the following metrics:

#### Request Metrics
- `signalforge_request_latency_seconds`: Histogram of request latencies
- `signalforge_request_total`: Counter of total requests by endpoint, method, and status
- `signalforge_active_requests`: Gauge of currently active requests

#### User Metrics
- `signalforge_active_users`: Gauge of active users

#### Signal Generation Metrics
- `signalforge_signal_generation_total`: Counter of signals generated by type

#### ML Model Metrics
- `signalforge_model_inference_latency_seconds`: Histogram of model inference latencies

#### Database Metrics
- `signalforge_db_query_latency_seconds`: Histogram of database query latencies

### Example Queries

```promql
# Average request latency per endpoint
rate(signalforge_request_latency_seconds_sum[5m]) / rate(signalforge_request_latency_seconds_count[5m])

# Request rate by status code
sum(rate(signalforge_request_total[5m])) by (status)

# 95th percentile of model inference latency
histogram_quantile(0.95, rate(signalforge_model_inference_latency_seconds_bucket[5m]))

# Database query rate by type
sum(rate(signalforge_db_query_latency_seconds_count[5m])) by (query_type)
```

### Alerting

To configure alerting, create an `alerts.yml` file and reference it in the Prometheus configuration.

Example alert rules:

```yaml
groups:
  - name: signalforge
    interval: 30s
    rules:
      - alert: HighErrorRate
        expr: sum(rate(signalforge_request_total{status=~"5.."}[5m])) / sum(rate(signalforge_request_total[5m])) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: High error rate detected
          description: Error rate is above 5% for 5 minutes

      - alert: HighLatency
        expr: histogram_quantile(0.95, rate(signalforge_request_latency_seconds_bucket[5m])) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: High request latency detected
          description: 95th percentile latency is above 1 second
```
